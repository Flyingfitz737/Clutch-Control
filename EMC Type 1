#include <Arduino.h>
#include <PID_v1.h>
#include <Servo.h>

// ===== EMC Type 1 Controller for Arduino Uno =====
// Hydraulic clutch controller with user-defined parameters,
// automatic sensor inputs, PID control, and LED feedback

// ===== Pin Definitions =====
const int rpmSensorPin = 3;         // Digital pin for RPM sensor pulse train (interrupt pin)
const int potentiometerPin = A1;    // Additional potentiometer input
const int servoPin = 9;             // PWM pin for servo motor control
const int armLightPin = 13;         // LED pin for arming light (built-in LED)
const int armSwitchPin = 2;         // Digital pin for arm switch


// ===== Global Variables =====
// RPM pulse counting variables (volatile for ISR)
volatile unsigned long pulseCount = 0;
volatile unsigned long lastPulseTime = 0;
unsigned long lastRPMCalculation = 0;
const unsigned long rpmCalculationInterval = 1000; // Calculate RPM every 1000ms
const int pulsesPerRevolution = 1; // Assuming 1 pulse per revolution for ECU signal

// Sensor readings
int potValue = 0;
bool armSwitch = false;

bool systemArmed = false;

// PID Control Variables
double setpointRPM = 1000.0;        // Target RPM (user-configurable)
double currentRPM = 0.0;            // Current RPM from sensor
double pidOutput = 0.0;             // PID output (0-255 for PWM)
double Kp = 2.0, Ki = 5.0, Kd = 1.0; // PID constants (user-configurable)

// Servo control
Servo clutchServo;
int servoPosition = 90;             // Servo position (0-180 degrees)

// PID Controller
PID myPID(&currentRPM, &pidOutput, &setpointRPM, Kp, Ki, Kd, DIRECT);

// Serial communication variables
String inputString = "";
bool stringComplete = false;

// Timing variables
unsigned long lastPrintTime = 0;
const unsigned long printInterval = 500; // Print status every 500ms

// ===== Setup Function =====
void setup() {
  Serial.begin(9600);
  
  // Initialize pin modes
  pinMode(rpmSensorPin, INPUT_PULLUP); // Digital input with pullup for RPM pulse train
  pinMode(potentiometerPin, INPUT);
  pinMode(armLightPin, OUTPUT);
  pinMode(armSwitchPin, INPUT_PULLUP);

  // Setup interrupt for RPM pulse counting (falling edge detection)
  attachInterrupt(digitalPinToInterrupt(rpmSensorPin), rpmPulseISR, FALLING);
  
  // Initialize timing variables
  lastRPMCalculation = millis();
  
  // Initialize servo
  clutchServo.attach(servoPin);
  clutchServo.write(servoPosition);
  
  // Initialize PID controller
  myPID.SetMode(AUTOMATIC);
  myPID.SetOutputLimits(0, 180); // Servo range 0-180 degrees
  
  // Initialize outputs
  digitalWrite(armLightPin, LOW);
  
  // Reserve string space for serial input
  inputString.reserve(200);
  
  // Print startup message
  Serial.println("=== EMC Type 1 Controller Initialized ===");
  Serial.println("RPM Input: Digital pulse train on pin 3 (interrupt)");
  Serial.println("Commands:");
  Serial.println("  setrpm <value>     - Set target RPM");
  Serial.println("  setpid <kp> <ki> <kd> - Set PID constants");
  Serial.println("  arm                - Arm the system");
  Serial.println("  disarm             - Disarm the system");
  Serial.println("  status             - Show current status");
  Serial.println("  help               - Show this help");
  Serial.println("========================================");
  printStatus();
}

// ===== Main Loop =====
void loop() {
  // Read sensor inputs
  readSensors();
  
  // Process serial commands
  processSerialInput();
  
  // Update system state
  updateSystemState();
  
  // Run PID control if armed
  if (systemArmed) {
    runPIDControl();
  } else {
    // Return servo to neutral position when disarmed
    servoPosition = 90;
    clutchServo.write(servoPosition);
  }
  
  // Update outputs
  updateOutputs();
  
  // Print status periodically
  if (millis() - lastPrintTime >= printInterval) {
    printStatus();
    lastPrintTime = millis();
  }
  
  delay(50); // Small delay for stability
}

// ===== Function Implementations =====

// Interrupt Service Routine for RPM pulse counting
void rpmPulseISR() {
  pulseCount++;
  lastPulseTime = micros();
}

void readSensors() {
  // Calculate RPM from pulse count over time interval
  unsigned long currentTime = millis();
  
  if (currentTime - lastRPMCalculation >= rpmCalculationInterval) {
    // Calculate RPM: (pulses * 60 seconds) / (time_interval_in_seconds * pulses_per_revolution)
    unsigned long timeDelta = currentTime - lastRPMCalculation;
    
    noInterrupts(); // Disable interrupts while reading volatile variables
    unsigned long currentPulseCount = pulseCount;
    pulseCount = 0; // Reset pulse count for next interval
    interrupts(); // Re-enable interrupts
    
    // Calculate RPM
    if (timeDelta > 0) {
      currentRPM = (currentPulseCount * 60000.0) / (timeDelta * pulsesPerRevolution);
    }
    
    lastRPMCalculation = currentTime;
  }
  
  // Read potentiometer
  potValue = analogRead(potentiometerPin);
  
  // Read digital switches (active LOW with pullup)
  armSwitch = !digitalRead(armSwitchPin);

}

void processSerialInput() {
  // Check for serial input
  while (Serial.available()) {
    char inChar = (char)Serial.read();
    
    if (inChar == '\n') {
      stringComplete = true;
    } else {
      inputString += inChar;
    }
  }
  
  // Process complete command
  if (stringComplete) {
    processCommand(inputString);
    inputString = "";
    stringComplete = false;
  }
}

void processCommand(String command) {
  command.trim();
  command.toLowerCase();
  
  if (command.startsWith("setrpm ")) {
    double newSetpoint = command.substring(7).toDouble();
    if (newSetpoint > 0 && newSetpoint <= 5000) {
      setpointRPM = newSetpoint;
      Serial.println("Target RPM set to: " + String(setpointRPM));
    } else {
      Serial.println("Invalid RPM value. Range: 1-5000");
    }
  }
  else if (command.startsWith("setpid ")) {
    // Parse PID values: setpid kp ki kd
    int firstSpace = command.indexOf(' ', 7);
    int secondSpace = command.indexOf(' ', firstSpace + 1);
    
    if (firstSpace > 0 && secondSpace > 0) {
      double newKp = command.substring(7, firstSpace).toDouble();
      double newKi = command.substring(firstSpace + 1, secondSpace).toDouble();
      double newKd = command.substring(secondSpace + 1).toDouble();
      
      if (newKp >= 0 && newKi >= 0 && newKd >= 0) {
        Kp = newKp;
        Ki = newKi;
        Kd = newKd;
        myPID.SetTunings(Kp, Ki, Kd);
        Serial.println("PID constants updated:");
        Serial.println("  Kp: " + String(Kp));
        Serial.println("  Ki: " + String(Ki));
        Serial.println("  Kd: " + String(Kd));
      } else {
        Serial.println("Invalid PID values. Must be non-negative.");
      }
    } else {
      Serial.println("Usage: setpid <kp> <ki> <kd>");
    }
  }
  else if (command == "arm") {
    systemArmed = true;
    Serial.println("System ARMED");
  }
  else if (command == "disarm") {
    systemArmed = false;
    Serial.println("System DISARMED");
  }
  else if (command == "status") {
    printDetailedStatus();
  }
  else if (command == "help") {
    printHelp();
  }
  else {
    Serial.println("Unknown command: " + command);
    Serial.println("Type 'help' for available commands.");
  }
}

void updateSystemState() {
  // System is armed if either arm switch is pressed OR armed via serial
  bool shouldBeArmed = systemArmed || armSwitch;
  
  if (shouldBeArmed && !systemArmed) {
    systemArmed = true;
    Serial.println("System ARMED via switch");
  } else if (!shouldBeArmed && systemArmed && !armSwitch) {
    // Only disarm if switch is released and not armed via serial
    systemArmed = false;
    Serial.println("System DISARMED via switch");
  }
}

void runPIDControl() {
  // Compute PID output
  if (myPID.Compute()) {
    // Map PID output to servo position
    servoPosition = (int)pidOutput;
    servoPosition = constrain(servoPosition, 0, 180);
    clutchServo.write(servoPosition);
  }
}

void updateOutputs() {
  // Update arm light - solid on when armed, solid off when disarmed
  if (systemArmed) {
    // Solid on when armed
    digitalWrite(armLightPin, HIGH);
  } else {
    // Solid off when disarmed
    digitalWrite(armLightPin, LOW);
  }
}

void printStatus() {
  Serial.print("RPM: ");
  Serial.print(currentRPM);
  Serial.print(" | Target: ");
  Serial.print(setpointRPM);
  Serial.print(" | Servo: ");
  Serial.print(servoPosition);
  Serial.print("° | Armed: ");
  Serial.print(systemArmed ? "YES" : "NO");
  Serial.print(" | PID Out: ");
  Serial.println(pidOutput);
}

void printDetailedStatus() {
  Serial.println("=== EMC Type 1 Controller Status ===");
  Serial.println("Sensor Readings:");
  
  // Show pulse count and frequency information
  noInterrupts();
  unsigned long currentPulseCount = pulseCount;
  interrupts();
  
  Serial.println("  RPM Sensor: Digital pulse train on pin 3");
  Serial.println("  Current RPM: " + String(currentRPM));
  Serial.println("  Pulse Count (current interval): " + String(currentPulseCount));
  Serial.println("  Potentiometer: " + String(potValue));
  Serial.println("  Arm Switch: " + String(armSwitch ? "PRESSED" : "RELEASED"));

  Serial.println();
  
  Serial.println("Control Parameters:");
  Serial.println("  Target RPM: " + String(setpointRPM));
  Serial.println("  PID Kp: " + String(Kp));
  Serial.println("  PID Ki: " + String(Ki));
  Serial.println("  PID Kd: " + String(Kd));
  Serial.println();
  
  Serial.println("System State:");
  Serial.println("  Armed: " + String(systemArmed ? "YES" : "NO"));
  Serial.println("  Servo Position: " + String(servoPosition) + "°");
  Serial.println("  PID Output: " + String(pidOutput));
  Serial.println("  Arm Light: " + String(digitalRead(armLightPin) ? "ON" : "OFF"));
  Serial.println("====================================");
}

void printHelp() {
  Serial.println("=== EMC Type 1 Controller Commands ===");
  Serial.println("setrpm <value>     - Set target RPM (1-5000)");
  Serial.println("setpid <kp> <ki> <kd> - Set PID constants");
  Serial.println("arm                - Arm the system");
  Serial.println("disarm             - Disarm the system");
  Serial.println("status             - Show detailed status");
  Serial.println("help               - Show this help");
  Serial.println("=======================================");
}