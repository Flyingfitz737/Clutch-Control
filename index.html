<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EMC BLE GUI</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
    .card { border: 1px solid #ccc; border-radius: 10px; padding: 12px; min-width: 280px; flex: 1 1 280px; }
    .card h3 { margin: 0 0 10px 0; font-size: 16px; }
    label { display: block; font-size: 12px; opacity: 0.8; margin-top: 8px; }
    input, select, button { font-size: 14px; padding: 8px; }
    input, select { width: 100%; box-sizing: border-box; }
    button { cursor: pointer; }
    #log { width: 100%; height: 220px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .kv { display: grid; grid-template-columns: 140px 1fr; gap: 6px; font-family: ui-monospace, monospace; }
    .kv div { padding: 2px 0; }
    .good { color: #0a7; } .bad { color: #c22; }
    .muted { opacity: 0.7; }
    .btnRow { display:flex; gap:8px; flex-wrap:wrap; }
    .btnRow button { flex: 1 1 120px; }
    hr { margin: 12px 0; border: none; border-top: 1px solid #ddd; }
    h4 { font-size: 14px; margin: 8px 0; }
    .pill { display:inline-block; padding:2px 6px; border-radius:6px; background:#f2f2f2; font-size:12px; }
    #chartWrap { width: 100%; height: 380px; }
    #chartTitle { margin: 8px 0; font-weight: 600; }
  </style>
</head>
<body>
  <h2>EMC BLE GUI - Complete Control (Updated)</h2>

  <div class="row">
    <div class="card">
      <h3>Connection</h3>
      <div class="btnRow">
        <button id="btnConnect">Connect</button>
        <button id="btnDisconnect" disabled>Disconnect</button>
      </div>

      <div style="margin-top:10px;">
        <div>Status: <span id="connStatus" class="bad">disconnected</span></div>
        <div>Device: <span id="devName">—</span></div>
      </div>

      <div style="margin-top:12px;" class="btnRow">
        <button id="btnGetAll" disabled>Get All</button>
        <button id="btnSave" disabled>Save</button>
        <button id="btnArm" disabled>Arm</button>
        <button id="btnDisarm" disabled>Disarm</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        <div>Tip: Connect → auto-sends <code>getall</code>.</div>
      </div>
    </div>

    <div class="card">
      <h3>Live Readouts</h3>
      <div class="kv">
        <div>rpm</div><div id="v_rpm">—</div>
        <div>target</div><div id="v_target">—</div>
        <div>servo</div><div id="v_servo">—</div>
        <div>mode</div><div id="v_mode">—</div>
        <div>pid_out</div><div id="v_pid_out">—</div>
        <div>dirty</div><div id="v_dirty">—</div>

        <div>prehold</div><div id="v_prehold">—</div>
        <div>override_en</div><div id="v_override_en">—</div>
        <div>pending</div><div id="v_pending">—</div>
        <div>latched</div><div id="v_latched">—</div>
        <div>ov_trip</div><div id="v_ov_trip">—</div>
        <div>cooldown_ms</div><div id="v_cooldown_ms">—</div>
      </div>
    </div>

    <div class="card">
      <h3>PID</h3>
      <label>Target RPM</label>
      <input id="inSetRpm" type="number" step="1" />
      <button id="btnSetRpm" disabled>Send setrpm</button>

      <label>Kp Ki Kd</label>
      <div class="row" style="gap:8px;">
        <input id="inKp" type="number" step="0.000001" placeholder="Kp" />
        <input id="inKi" type="number" step="0.000001" placeholder="Ki" />
        <input id="inKd" type="number" step="0.000001" placeholder="Kd" />
      </div>
      <button id="btnSetPid" disabled>Send setpid</button>

      <label>PID Direction</label>
      <select id="selPidDir">
        <option value="direct">DIRECT</option>
        <option value="reverse">REVERSE</option>
      </select>
      <button id="btnPidDir" disabled>Send piddir</button>

      <label>Aggressiveness (0.1–3.0)</label>
      <input id="inAggr" type="number" step="0.1" min="0.1" max="3.0" />
      <button id="btnAggr" disabled>Send aggressiveness</button>
    </div>

    <div class="card">
      <h3>Timing & RPM</h3>
      <label>PPR</label>
      <select id="selPpr">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="4">4</option>
      </select>
      <button id="btnPpr" disabled>Send ppr</button>

      <label>Sample time</label>
      <div class="pill">Fixed 3 ms (333 Hz)</div>

      <label>RPM Filter Alpha (0.10–0.50)</label>
      <input id="inAlpha" type="number" step="0.01" min="0.10" max="0.50" />
      <button id="btnAlpha" disabled>Send setalpha</button>

      <label>Pre-PID start position (deg)</label>
      <input id="inStart" type="number" step="1" min="0" max="180" />
      <button id="btnStart" disabled>Send setstart</button>

      <label>Prehold</label>
      <div class="btnRow">
        <button id="btnPreholdOn" disabled>Prehold ON</button>
        <button id="btnPreholdOff" disabled>Prehold OFF</button>
      </div>
    </div>

    <div class="card">
      <h3>Telemetry</h3>
      <label>Mode</label>
      <select id="selTeleMode">
        <option value="auto">AUTO</option>
        <option value="on">ON</option>
        <option value="off">OFF</option>
      </select>
      <button id="btnTeleMode" disabled>Send telemetry mode</button>

      <label>Rate (ms 50–5000)</label>
      <input id="inTeleMs" type="number" step="10" min="50" max="5000" />
      <button id="btnTeleRate" disabled>Send telemetry rate</button>
    </div>

    <div class="card">
      <h3>Safety Override</h3>
      <label>Enable/Disable</label>
      <div class="btnRow">
        <button id="btnSafetyEn" disabled>Enable</button>
        <button id="btnSafetyDis" disabled>Disable</button>
      </div>

      <label>Threshold (% 0–100)</label>
      <input id="inThrPct" type="number" step="1" min="0" max="100" />
      <button id="btnThrPct" disabled>Send threshold %</button>

      <label>Sense</label>
      <select id="selSense">
        <option value="normal">NORMAL</option>
        <option value="reversed">REVERSED</option>
      </select>
      <button id="btnSense" disabled>Send sense</button>
    </div>

    <div class="card">
      <h3>Calibration</h3>
      <label>Servo Min (deg)</label>
      <input id="inCalMin" type="number" step="1" min="0" max="180" />
      <button id="btnCalMin" disabled>Send set_min</button>

      <label>Servo Max (deg)</label>
      <input id="inCalMax" type="number" step="1" min="0" max="180" />
      <button id="btnCalMax" disabled>Send set_max</button>

      <label>Servo Neutral (deg)</label>
      <input id="inCalNeutral" type="number" step="1" min="0" max="180" />
      <button id="btnCalNeutral" disabled>Send set_neutral</button>

      <label>Direction</label>
      <select id="selCalDir">
        <option value="0">NORMAL</option>
        <option value="1">REVERSED</option>
      </select>
      <button id="btnCalDir" disabled>Send direction</button>

      <label>Manual Pot Min (ADC)</label>
      <input id="inPotMin" type="number" step="1" min="0" max="4095" />
      <button id="btnPotMin" disabled>Send pot_min</button>

      <label>Manual Pot Max (ADC)</label>
      <input id="inPotMax" type="number" step="1" min="0" max="4095" />
      <button id="btnPotMax" disabled>Send pot_max</button>
    </div>

    <div class="card">
      <h3>Logging</h3>
      <label>List logs</label>
      <button id="btnLogList" disabled>log list</button>

      <label>Read log file (binary)</label>
      <input id="inLogRead" type="text" placeholder="/log_1_123456.bin" />
      <div class="btnRow">
        <button id="btnLogRead" disabled>log read</button>
        <button id="btnLogCancel" disabled>log cancel</button>
      </div>

      <label>CSV export</label>
      <div class="btnRow">
        <button id="btnCsv" disabled>Download CSV</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        Download reads binary → auto converts to CSV + chart.
      </div>
    </div>
  </div>

  <h3>Graph</h3>
  <div id="chartTitle">No log loaded.</div>
  <div id="chartWrap">
    <canvas id="logChart"></canvas>
  </div>

  <h3>Log</h3>
  <textarea id="log" readonly></textarea>

<script>
  const NUS_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
  const NUS_RX      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
  const NUS_TX      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

  let device = null;
  let server = null;
  let rxChar = null;
  let txChar = null;

  let notifyBuf = "";

  // Binary log capture state
  let logBinaryActive = false;
  let logExpectedBytes = 0;
  let logReceivedBytes = 0;
  let logChunks = [];
  let logCsvText = "";
  let lastLogMeta = null;

  let chart = null;

  const $ = (id) => document.getElementById(id);

  function logLine(s) {
    $("log").value += s + "\n";
    $("log").scrollTop = $("log").scrollHeight;
  }

  function setConnected(yes) {
    $("btnDisconnect").disabled = !yes;
    $("btnConnect").disabled = yes;

    const enable = (id) => $(id).disabled = !yes;
    [
      "btnGetAll","btnSave","btnArm","btnDisarm",
      "btnSetRpm","btnSetPid","btnPidDir","btnAggr",
      "btnPpr","btnAlpha","btnStart",
      "btnPreholdOn","btnPreholdOff",
      "btnTeleMode","btnTeleRate",
      "btnSafetyEn","btnSafetyDis","btnThrPct","btnSense",
      "btnCalMin","btnCalMax","btnCalNeutral","btnCalDir","btnPotMin","btnPotMax",
      "btnLogList","btnLogRead","btnLogCancel","btnCsv"
    ].forEach(enable);

    $("connStatus").textContent = yes ? "connected" : "disconnected";
    $("connStatus").className = yes ? "good" : "bad";
  }

  function setText(id, v) {
    const el = $(id);
    if (!el) return;
    el.textContent = v;
  }

  function applyKV(k, v) {
    const map = {
      rpm: "v_rpm",
      target: "v_target",
      servo: "v_servo",
      mode: "v_mode",
      pid_out: "v_pid_out",
      dirty: "v_dirty",

      prehold: "v_prehold",
      override_en: "v_override_en",
      pending: "v_pending",
      latched: "v_latched",
      ov_trip: "v_ov_trip",
      cooldown_ms: "v_cooldown_ms"
    };

    if (map[k]) setText(map[k], v);

    if (k === "target") $("inSetRpm").value = v;
    if (k === "kp") $("inKp").value = v;
    if (k === "ki") $("inKi").value = v;
    if (k === "kd") $("inKd").value = v;
    if (k === "aggr") $("inAggr").value = v;
    if (k === "ppr") $("selPpr").value = String(v);
    if (k === "alpha") $("inAlpha").value = v;
    if (k === "start_pos") $("inStart").value = v;

    if (k === "ov_thr_pct") $("inThrPct").value = v;
    if (k === "ov_sense") $("selSense").value = (String(v) === "1") ? "reversed" : "normal";
    if (k === "pid_dir") $("selPidDir").value = (String(v).toLowerCase().includes("rev")) ? "reverse" : "direct";
    if (k === "tele_mode") $("selTeleMode").value = String(v).toLowerCase();
    if (k === "tele_ms") $("inTeleMs").value = v;

    if (k === "min_pos") $("inCalMin").value = v;
    if (k === "max_pos") $("inCalMax").value = v;
    if (k === "neutral_pos") $("inCalNeutral").value = v;
    if (k === "cal_dir") $("selCalDir").value = String(v);
    if (k === "pot_min") $("inPotMin").value = v;
    if (k === "pot_max") $("inPotMax").value = v;
  }

  function parseLogBegin(line) {
    const sizeMatch = line.match(/size=(\d+)/);
    if (!sizeMatch) return;
    logExpectedBytes = parseInt(sizeMatch[1], 10);
    logReceivedBytes = 0;
    logChunks = [];
    logBinaryActive = true;
    logLine(`[LOG] binary read started (${logExpectedBytes} bytes)`);
  }

  function parseLine(line) {
    line = line.trim();
    if (!line) return;

    if (line === "end") return;

    if (line.startsWith("logfile_begin ")) {
      parseLogBegin(line);
      return;
    }

    if (line.startsWith("logfile_end ")) {
      logLine("[LOG] binary read completed");
      return;
    }

    if (line.startsWith("tele ")) {
      const parts = line.substring(5).split(/\s+/);
      for (const p of parts) {
        if (p === "end") break;
        const i = p.indexOf("=");
        if (i > 0) applyKV(p.substring(0, i), p.substring(i + 1));
      }
      return;
    }

    if (line.startsWith("status ")) {
      const parts = line.substring(7).split(/\s+/);
      for (const p of parts) {
        const i = p.indexOf("=");
        if (i > 0) applyKV(p.substring(0, i), p.substring(i + 1));
      }
      return;
    }

    if (line.startsWith("ack ")) {
      logLine("[ACK] " + line);
      return;
    }

    const i = line.indexOf("=");
    if (i > 0) {
      applyKV(line.substring(0, i), line.substring(i + 1));
      return;
    }

    logLine(line);
  }

  function handleNotifyBytes(bytes) {
    if (logBinaryActive) {
      const remaining = logExpectedBytes - logReceivedBytes;
      if (remaining > 0) {
        const take = Math.min(remaining, bytes.length);
        logChunks.push(bytes.slice(0, take));
        logReceivedBytes += take;

        if (logReceivedBytes >= logExpectedBytes) {
          logBinaryActive = false;
          const extra = bytes.slice(take);
          finalizeLogBinary();
          if (extra.length > 0) {
            const text = new TextDecoder().decode(extra);
            handleNotifyText(text);
          }
        }
        return;
      }
    }

    const text = new TextDecoder().decode(bytes);
    handleNotifyText(text);
  }

  function handleNotifyText(text) {
    notifyBuf += text;
    const lines = notifyBuf.split(/\r?\n/);
    notifyBuf = lines.pop();
    for (const line of lines) parseLine(line);
  }

  function concatChunks(chunks, total) {
    const out = new Uint8Array(total);
    let offset = 0;
    for (const c of chunks) {
      out.set(c, offset);
      offset += c.length;
    }
    return out;
  }

  function readCString(view, offset, max) {
    const bytes = [];
    for (let i = 0; i < max; i++) {
      const b = view.getUint8(offset + i);
      if (b === 0) break;
      bytes.push(b);
    }
    return new TextDecoder().decode(new Uint8Array(bytes));
  }

  function finalizeLogBinary() {
    const bin = concatChunks(logChunks, logReceivedBytes);
    logChunks = [];
    if (bin.length < 56) {
      logLine("[LOG] binary too small");
      return;
    }

    const view = new DataView(bin.buffer, bin.byteOffset, bin.byteLength);
    const magic = String.fromCharCode(
      view.getUint8(0), view.getUint8(1), view.getUint8(2), view.getUint8(3)
    );
    if (magic !== "EMC1") {
      logLine("[LOG] invalid magic");
      return;
    }

    const version = view.getUint16(4, true);
    const headerSize = view.getUint16(6, true);
    const recordSize = view.getUint16(8, true);
    const sampleHz = view.getUint16(10, true);
    const startMs = view.getUint32(12, true);
    const eventId = view.getUint32(16, true);
    const kp = view.getFloat32(20, true);
    const ki = view.getFloat32(24, true);
    const kd = view.getFloat32(28, true);
    const aggr = view.getFloat32(32, true);
    const overrideEnabled = view.getUint8(36);
    const overrideThresholdPct = view.getUint8(37);
    const overrideSenseReversed = view.getUint8(38);
    const pidDirection = view.getUint8(39);
    const fwVersion = readCString(view, 40, 16);

    const footerSize = 8;
    const dataStart = headerSize;
    const dataEnd = bin.length - footerSize;
    const recordCount = Math.floor((dataEnd - dataStart) / recordSize);

    const times = [];
    const rpm = [];
    const target = [];
    const servo = [];
    const pidOut = [];
    const flags = [];

    let firstTs = null;
    let offset = dataStart;
    for (let i = 0; i < recordCount; i++) {
      const ts = view.getUint32(offset, true); offset += 4;
      const r = view.getUint16(offset, true); offset += 2;
      const t = view.getUint16(offset, true); offset += 2;
      const s = view.getUint16(offset, true); offset += 2;
      const f = view.getUint8(offset); offset += 1;
      const p = view.getUint16(offset, true); offset += 2;

      if (firstTs === null) firstTs = ts;
      times.push((ts - firstTs) / 1000.0);
      rpm.push(r);
      target.push(t);
      servo.push(s);
      pidOut.push(p);
      flags.push(f);
    }

    lastLogMeta = {
      version, headerSize, recordSize, sampleHz, startMs, eventId,
      kp, ki, kd, aggr, overrideEnabled, overrideThresholdPct, overrideSenseReversed,
      pidDirection, fwVersion
    };

    updateChart(times, rpm, target, servo, pidOut, lastLogMeta);
    buildCsv(times, rpm, target, servo, pidOut, flags, lastLogMeta);

    logLine(`[LOG] parsed ${recordCount} records (event ${eventId})`);
  }

  function buildCsv(times, rpm, target, servo, pidOut, flags, meta) {
    let csv = "";
    csv += `# event_id=${meta.eventId}\n`;
    csv += `# start_ms=${meta.startMs}\n`;
    csv += `# sample_hz=${meta.sampleHz}\n`;
    csv += `# fw=${meta.fwVersion}\n`;
    csv += `# kp=${meta.kp} ki=${meta.ki} kd=${meta.kd} aggr=${meta.aggr}\n`;
    csv += "t_sec,rpm,target,servo,pid_out,flags\n";
    for (let i = 0; i < times.length; i++) {
      csv += `${times[i].toFixed(3)},${rpm[i]},${target[i]},${servo[i]},${pidOut[i]},${flags[i]}\n`;
    }
    logCsvText = csv;
    $("btnCsv").disabled = false;
  }

  function updateChart(times, rpm, target, servo, pidOut, meta) {
    const title = `Event ${meta.eventId} | start_ms=${meta.startMs} | fw=${meta.fwVersion}`;
    $("chartTitle").textContent = title;

    const ctx = $("logChart").getContext("2d");
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: times,
        datasets: [
          { label: "RPM", data: rpm, borderColor: "#1f77b4", fill: false, pointRadius: 0 },
          { label: "Target", data: target, borderColor: "#ff7f0e", fill: false, pointRadius: 0 },
          { label: "Servo", data: servo, borderColor: "#2ca02c", fill: false, pointRadius: 0 },
          { label: "PID Out", data: pidOut, borderColor: "#d62728", fill: false, pointRadius: 0 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { position: "top" },
          title: { display: true, text: title }
        },
        scales: {
          x: { title: { display: true, text: "Time (s)" } },
          y: { title: { display: true, text: "Value" } }
        }
      }
    });
  }

  async function connect() {
    if (!navigator.bluetooth) {
      alert("Web Bluetooth not available in this browser.");
      return;
    }

    device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [NUS_SERVICE] }],
      optionalServices: [NUS_SERVICE]
    });

    $("devName").textContent = device.name || "(unnamed)";
    device.addEventListener("gattserverdisconnected", () => {
      logLine("[BLE] disconnected");
      setConnected(false);
      rxChar = null; txChar = null; server = null;
      notifyBuf = "";
    });

    server = await device.gatt.connect();
    const svc = await server.getPrimaryService(NUS_SERVICE);

    rxChar = await svc.getCharacteristic(NUS_RX);
    txChar = await svc.getCharacteristic(NUS_TX);

    await txChar.startNotifications();
    txChar.addEventListener("characteristicvaluechanged", (ev) => {
      const bytes = new Uint8Array(ev.target.value.buffer);
      handleNotifyBytes(bytes);
    });

    setConnected(true);
    logLine("[BLE] connected");
    await sendCmd("getall");
  }

  async function disconnect() {
    try {
      if (device && device.gatt && device.gatt.connected) device.gatt.disconnect();
    } finally {
      setConnected(false);
      rxChar = null; txChar = null; server = null;
      notifyBuf = "";
    }
  }

  async function sendCmd(cmd) {
    if (!rxChar) return;
    const enc = new TextEncoder();
    const data = enc.encode(cmd + "\n");

    if (rxChar.properties.writeWithoutResponse) {
      await rxChar.writeValueWithoutResponse(data);
    } else {
      await rxChar.writeValue(data);
    }
    logLine(">> " + cmd);
  }

  function downloadCsv() {
    if (!logCsvText) return;
    const blob = new Blob([logCsvText], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const eventLabel = lastLogMeta ? lastLogMeta.eventId : "log";
    a.href = url;
    a.download = `emc_event_${eventLabel}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // UI wiring
  $("btnConnect").onclick = connect;
  $("btnDisconnect").onclick = disconnect;

  $("btnGetAll").onclick = () => sendCmd("getall");
  $("btnSave").onclick = () => sendCmd("save");
  $("btnArm").onclick = () => sendCmd("arm");
  $("btnDisarm").onclick = () => sendCmd("disarm");

  $("btnSetRpm").onclick = () => sendCmd(`setrpm ${$("inSetRpm").value}`);
  $("btnSetPid").onclick = () => sendCmd(`setpid ${$("inKp").value} ${$("inKi").value} ${$("inKd").value}`);
  $("btnPidDir").onclick = () => sendCmd(`piddir ${$("selPidDir").value}`);
  $("btnAggr").onclick = () => sendCmd(`aggressiveness ${$("inAggr").value}`);

  $("btnPpr").onclick = () => sendCmd(`ppr ${$("selPpr").value}`);
  $("btnAlpha").onclick = () => sendCmd(`setalpha ${$("inAlpha").value}`);
  $("btnStart").onclick = () => sendCmd(`setstart ${$("inStart").value}`);

  $("btnPreholdOn").onclick  = () => sendCmd("prehold on");
  $("btnPreholdOff").onclick = () => sendCmd("prehold off");

  $("btnTeleMode").onclick = () => sendCmd(`telemetry ${$("selTeleMode").value}`);
  $("btnTeleRate").onclick = () => sendCmd(`telemetry rate ${$("inTeleMs").value}`);

  $("btnSafetyEn").onclick = () => sendCmd("safety enable");
  $("btnSafetyDis").onclick = () => sendCmd("safety disable");
  $("btnThrPct").onclick = () => sendCmd(`safety set_threshold_pct ${$("inThrPct").value}`);
  $("btnSense").onclick = () => sendCmd(`safety sense ${$("selSense").value}`);

  $("btnCalMin").onclick = () => sendCmd(`calibrate set_min ${$("inCalMin").value}`);
  $("btnCalMax").onclick = () => sendCmd(`calibrate set_max ${$("inCalMax").value}`);
  $("btnCalNeutral").onclick = () => sendCmd(`calibrate set_neutral ${$("inCalNeutral").value}`);
  $("btnCalDir").onclick = () => sendCmd(`calibrate direction ${$("selCalDir").value}`);
  $("btnPotMin").onclick = () => sendCmd(`calibrate pot_min ${$("inPotMin").value}`);
  $("btnPotMax").onclick = () => sendCmd(`calibrate pot_max ${$("inPotMax").value}`);

  $("btnLogList").onclick = () => sendCmd("log list");
  $("btnLogRead").onclick = () => sendCmd(`log read ${$("inLogRead").value}`);
  $("btnLogCancel").onclick = () => sendCmd("log cancel");

  $("btnCsv").onclick = downloadCsv;

  setConnected(false);
  logLine("[GUI] ready. Click Connect.");
</script>
</body>
</html>
